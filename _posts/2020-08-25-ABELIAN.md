---
layout: post
title: "Abelian"
subtitle: "Abelian"
date: 2020-08-25 18:36:00
author: "Krystian Wojcicki"
header-img: "img/posts/jekyll-bg.jpg"
comments: true
tags: [Tutorial]
---

<script type="text/javascript" async src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML'></script>

<div style="display: inline;">
  
<button onclick="stop_sim()">Stop Simulation</button>

<button onclick="restart()">Restart</button>

<br/>
<br/>
<label for="height">Height</label>
<input type="number" id="height" onchange="height_change()">

<label for="width">Width</label>
<input type="number" id="width" onchange="width_change()">

</div>
<canvas id="myCanvas" width="700" height="700"></canvas>

<script>
var width = 350;
var height = 350;
var stop = false;
var drawingTime = null;
var sand;
var oldSand;

const colors = {
  0: "black",
  1: "red",
  2: "blue",
  3: "green"
}

var c = document.getElementById("myCanvas");
var ctx = c.getContext("2d");

document.getElementById("height").value = height + "";
document.getElementById("width").value = width + "";

function height_change(){
  console.log("new height:", document.getElementById("height").value)
  height = document.getElementById("height").value
  clearTimeout(drawingTime);
  restart();
}

function width_change(){
  console.log("new width:", document.getElementById("width").value)
  width = document.getElementById("width").value
  clearTimeout(drawingTime);
  restart();
}

function stop_sim(){
  stop = true;
}

function restart(){
  ctx.fillStyle = "black";

  sand = new Array(height);
  oldSand = new Array(height);

  for(var i = 0; i < height; i++){
    sand[i] = new Array(width);
    oldSand[i] = new Array(width);
    for(var j = 0; j < width; j++){
      sand[i][j] = 0;
      oldSand[i][j] = 0;
    }
  }

  for(var i = 0; i <  height; i++){
    for(var j = 0; j < width; j++){
      ctx.fillRect(i * 2, j * 2, 2, 2);
    }
  }

  const starting = 5
  var i = 0;

  function run(){
    if(stop) return;
    add_sand(height / 2, width / 2, starting);
    console.log("done step", i);
    i++;
    if(i % 500 == 0){
      drawingTime = setTimeout(function(){
        draw();
        run();
      }, 2000);
    } else {
      run();
    }
  }

  run();
}

restart();

function draw(){
  for(var i = 0; i < height; i++){
    for(var j = 0; j < width; j++){
      if(sand[i][j] != oldSand[i][j]){
        const toColor = colors[sand[i][j]] || "yellow"
        ctx.fillStyle = toColor;
        ctx.fillRect(i * 2, j * 2, 2, 2);
      }
    }
  }

  oldSand = sand.map(function(arr) {
    return arr.slice();
  });
}

function add_sand(x, y, inc){

  if(x < 0 || y < 0 || x >= height || y >= width) return

  sand[x][y] += inc

  while(sand[x][y] >= 4){
    //console.log(x, y, sand[x][y])
    sand[x][y] -= 4
    add_sand(x + 1, y, 1);
    add_sand(x - 1, y, 1);
    add_sand(x, y + 1, 1);
    add_sand(x, y - 1, 1);
  }
}
</script>
